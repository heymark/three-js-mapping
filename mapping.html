<!DOCTYPE html>
<html lang="en">

<head>
    <title>Three.js Mapping Test</title>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
    <link rel="stylesheet" type="text/css" href="style/style.css">
    <script src='js/three.min.js'></script>
    <script src='js/BoxGeometry.js'></script>
    <script src='js/Detector.js'></script>
    <script src='js/OrbitControls.js'></script>
</head>

<body>
    <div id="container"></div>
    <script>
        window.onload = function () {

            if (!Detector.webgl) {
                Detector.addGetWebGLMessage();
            }

            var ball, ballMaterial, ballModel, ballNormal, ballSpec, ballTexture, color,
                container, scene, camera, renderer;

            function addLight() {

                var ambientLight = new THREE.AmbientLight(0x909090);
                scene.add(ambientLight);

                var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(0, 0.5, -1);
                scene.add(directionalLight);

                var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(-2, -2, -1);
                scene.add(directionalLight);

                var hemiLight = new THREE.HemisphereLight(0xff0000, 0x00ffff, 0.05);
                scene.add(hemiLight);
            }

            /*
            function addModel() {

                boxModel = new THREE.BoxGeometry(3, 3, 3);

                // Load diffuse map
                boxTexture = THREE.ImageUtils.loadTexture("images/165-rock-diffuse.jpg");
                boxTexture.anisotropy = renderer.getMaxAnisotropy();

                // Load normal map
                boxNormal = THREE.ImageUtils.loadTexture("images/165-rock-normal.jpg");
                boxNormal.anisotropy = renderer.getMaxAnisotropy();

                // Set up material
                boxMaterial = new THREE.MeshPhongMaterial({
                    map: boxTexture,
                    normalMap: boxNormal
                });
                boxMaterial.shininess = 50;
                boxMaterial.specular = new THREE.Color("rgb(255, 225, 200)");

                // Create and position box
                box = new THREE.Mesh(boxModel, boxMaterial);
                box.position.set(0, 0.5, 0);
                scene.add(box);
            }
            */

            function addModel() {

                ballModel = new THREE.SphereGeometry(1.25, 32, 32);

                // Load diffuse map
                ballTexture = THREE.ImageUtils.loadTexture("images/165-rock-diffuse.jpg");
                ballTexture.anisotropy = renderer.getMaxAnisotropy();

                // Load normal map
                ballNormal = THREE.ImageUtils.loadTexture("images/165-rock-normal.jpg");
                ballNormal.anisotropy = renderer.getMaxAnisotropy();

                /* Load specular map
                ballSpec = THREE.ImageUtils.loadTexture("images/grid.png");
                ballSpec.anisotropy = renderer.getMaxAnisotropy(); */

                // Set up material
                ballMaterial = new THREE.MeshPhongMaterial({
                    map: ballTexture,
                    normalMap: ballNormal
                });
                ballMaterial.color = new THREE.Color("rgb(255, 0, 200)");
                ballMaterial.shininess = 30;
                ballMaterial.specular = new THREE.Color("rgb(255, 225, 200)");

                // Create and position ball
                ball = new THREE.Mesh(ballModel, ballMaterial);
                ball.position.set(0, 1, 0);
                scene.add(ball);
            }

            function colorCycle(target) {

                var clamp = 2,
                    gain = 0.25;

                color = color < 3 ? color + 0.005 : 0;

                if (color < 1) {
                    target.color.r = color / clamp + gain;
                    target.color.g = gain;
                    target.color.b = (1 - color) / clamp + gain;
                } else if (color < 2) {
                    target.color.r = (2 - color) / clamp + gain;
                    target.color.g = (color - 1) / clamp + gain;
                    target.color.b = gain;
                } else {
                    target.color.r = gain;
                    target.color.g = (3 - color) / clamp + gain;
                    target.color.b = (color - 2) / clamp + gain;
                }
            }

            function onWindowResize() {

                camera.aspect = container.offsetWidth / container.offsetHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);
                render();
            }

            function ready() {

                // Create scene
                scene = new THREE.Scene();

                /* Add grid
                var grid = new THREE.GridHelper(2, 1);
                grid.setColors(0x333333, 0x333333);
                scene.add(grid); */

                // Set up renderer
                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });
                renderer.setClearColor(0x000000, 0);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);

                // Add renderer to page
                container = document.getElementById('container');
                container.appendChild(renderer.domElement);

                // Set up camera 
                var aspect = container.offsetWidth / container.offsetHeight;
                camera = new THREE.PerspectiveCamera(60, aspect, 0.01, 50);

                /* Set up orbit controls
                orbit = new THREE.OrbitControls(camera, container);
                orbit.addEventListener('change', render); */

                // Set camera position
                camera.position.x = 2;
                camera.position.y = 2;
                camera.position.z = 2;

                // Set up camera target
                var target = new THREE.Vector3(0, 1, 0);
                camera.lookAt(target);
                /* orbit.target = target; */

                // Update camera
                camera.updateProjectionMatrix();

                // Add light and model
                addLight();
                addModel();

                // Add window resize listener
                window.addEventListener('resize', onWindowResize, false);
            }

            function render() {
                requestAnimationFrame(render);
                renderer.render(scene, camera);

                ball.rotation.x += 0.005;
                ball.rotation.y += 0.005;

                colorCycle(ballMaterial);
            }

            // Build scene
            ready();

            // Render
            render();
        };
    </script>
</body>

</html>